<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Math - B·∫£ng X·∫øp H·∫°ng</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
        body { margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%); font-family: 'Fredoka', sans-serif; color: white; overflow: hidden; user-select: none; }
        .game-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; width: 350px; position: relative; }
        
        /* ... (C√°c CSS c≈© gi·ªØ nguy√™n) ... */
        .timer-bar { width: 100%; height: 12px; background-color: rgba(0,0,0,0.3); border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
        .timer-fill { height: 100%; width: 100%; background-color: #00e676; transition: width 0.1s linear; }
        .top-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.2rem; }
        .lives { color: #ff5252; letter-spacing: 5px; }
        .score { color: #ffea00; }
        .question-box { font-size: 3.5rem; font-weight: 600; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); letter-spacing: 2px; }
        input[type="number"], input[type="text"], input[type="password"] { width: 80%; padding: 15px; font-size: 1.2rem; text-align: center; border: none; border-radius: 10px; outline: none; background: rgba(255, 255, 255, 0.9); color: #333; font-family: 'Fredoka', sans-serif; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: block; margin-left: auto; margin-right: auto; }
        input[type="number"] { font-size: 1.5rem; margin-bottom: 20px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .btn { padding: 12px 35px; font-size: 1.2rem; background: #ff4081; color: white; border: none; border-radius: 50px; cursor: pointer; font-family: 'Fredoka', sans-serif; transition: transform 0.1s; box-shadow: 0 5px 15px rgba(255, 64, 129, 0.4); margin-top: 10px; }
        .btn:active { transform: scale(0.95); }
        .btn-small { padding: 8px 20px; font-size: 1rem; background: #6c5ce7; margin-top: 10px; }
        .btn-gold { background: #f1c40f; color: #333; }
        .shake { animation: shake 0.4s; border: 3px solid #ff5252 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .correct-anim { border: 3px solid #00e676 !important; }
        .hint-text { color: #aaa; font-size: 0.9rem; margin-top: 10px; }
        #user-info-display { position: absolute; top: -40px; left: 0; width: 100%; text-align: center; color: #fff; font-size: 0.9rem; }

        /* --- CSS M·ªöI CHO B·∫¢NG X·∫æP H·∫†NG --- */
        .leaderboard-table {
            width: 90%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        .leaderboard-table th { border-bottom: 2px solid #fff; padding: 5px; color: #f1c40f; }
        .leaderboard-table td { padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .rank-1 { color: #ffd700; font-weight: bold; } /* V√†ng */
        .rank-2 { color: #c0c0c0; font-weight: bold; } /* B·∫°c */
        .rank-3 { color: #cd7f32; font-weight: bold; } /* ƒê·ªìng */
        .rank-icon { margin-right: 5px; }

    </style>
</head>
<body>

    <div class="game-container">
        <div id="user-info-display">Kh√°ch</div>
        <div class="timer-bar"><div class="timer-fill" id="timer"></div></div>
        
        <div class="top-info">
            <div class="lives" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div class="score">ƒêi·ªÉm: <span id="score">0</span></div>
        </div>
        
        <div class="question-box" id="question">?</div>
        <input type="number" id="answer-input" placeholder="?" autocomplete="off">
        <div class="hint-text">Nh·∫•n Enter ƒë·ªÉ tr·∫£ l·ªùi</div>

        <div class="overlay" id="auth-screen">
            <h2 id="auth-title" style="margin-bottom: 20px;">ƒêƒÉng Nh·∫≠p</h2>
            <input type="text" id="auth-user" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="auth-pass" placeholder="M·∫≠t kh·∫©u">
            <p id="auth-msg" style="color: #ff5252; font-size: 0.9rem; height: 20px;"></p>
            <button class="btn" onclick="handleAuth()" id="auth-action-btn">V√ÄO GAME</button>
            <p style="margin-top: 15px; font-size: 0.9rem; cursor: pointer; text-decoration: underline;" onclick="toggleAuthMode()" id="auth-toggle-text">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω</p>
        </div>

        <div class="overlay" id="start-screen" style="display: none;">
            <h2 style="font-size: 2rem; margin-bottom: 5px; color:#ff4081">Si√™u T·ªëc ƒê·ªô</h2>
            <p style="color: #ffd700; margin-bottom: 10px;">K·ª∑ l·ª•c c·ªßa b·∫°n: <span id="high-score-display">0</span></p>
            <button class="btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
            <button class="btn btn-gold" onclick="showLeaderboard()">üèÜ B·∫£ng X·∫øp H·∫°ng</button>
            <button class="btn btn-small" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <div class="overlay" id="game-over-screen" style="display: none;">
            <h2 style="font-size: 2.2rem; color: #ff5252;">THUA R·ªíI!</h2>
            <p style="font-size: 1.1rem; color: #ccc;">ƒêi·ªÉm s·ªë: <span id="final-score">0</span></p>
            <p id="new-record-msg" style="color: #00e676; font-weight: bold; display:none;">üèÜ K·ª∂ L·ª§C M·ªöI! üèÜ</p>
            <button class="btn" onclick="startGame()">CH∆†I L·∫†I</button>
            <button class="btn btn-gold" onclick="showLeaderboard()">üèÜ B·∫£ng X·∫øp H·∫°ng</button>
            <button class="btn btn-small" onclick="showStartScreen()">Menu</button>
        </div>

        <div class="overlay" id="leaderboard-screen" style="display: none;">
            <h2 style="color: #f1c40f; margin-bottom: 15px;">TOP CAO TH·ª¶</h2>
            
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th width="20%">H·∫°ng</th>
                        <th width="50%">T√™n</th>
                        <th width="30%">ƒêi·ªÉm</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    </tbody>
            </table>

            <div id="my-rank-container" style="width: 90%; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 10px; display: none;">
                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                    <span style="color: #00e676;">H·∫°ng c·ªßa b·∫°n: <span id="my-rank-num">#--</span></span>
                    <span style="color: #fff;">ƒêi·ªÉm: <span id="my-rank-score">0</span></span>
                </div>
            </div>

            <button class="btn btn-small" onclick="closeLeaderboard()">ƒê√≥ng</button>
        </div>

    </div>

    <script>
        // ... (Gi·ªØ nguy√™n c√°c bi·∫øn c≈©) ...
        const questionEl = document.getElementById('question');
        const inputEl = document.getElementById('answer-input');
        const scoreEl = document.getElementById('score');
        const finalScoreEl = document.getElementById('final-score');
        const timerBar = document.getElementById('timer');
        const livesEl = document.getElementById('lives');
        
        const authScreen = document.getElementById('auth-screen');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen'); // M√†n h√¨nh BXH

        const authUser = document.getElementById('auth-user');
        const authPass = document.getElementById('auth-pass');
        const authMsg = document.getElementById('auth-msg');
        const authTitle = document.getElementById('auth-title');
        const authActionBtn = document.getElementById('auth-action-btn');
        const authToggleText = document.getElementById('auth-toggle-text');
        const userInfoDisplay = document.getElementById('user-info-display');
        const highScoreDisplay = document.getElementById('high-score-display');
        const newRecordMsg = document.getElementById('new-record-msg');
        const leaderboardBody = document.getElementById('leaderboard-body'); // Body b·∫£ng

        let score = 0;
        let lives = 3;
        let correctAnswer = 0;
        let timerInterval;
        const TIME_PER_QUESTION = 5; 
        let timeLeft = TIME_PER_QUESTION;
        let isPlaying = false;
        
        let currentUser = null; 
        let isLoginMode = true;

        // ... (Gi·ªØ nguy√™n c√°c h√†m Auth v√† Logic Game c≈©) ...

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            authMsg.innerText = "";
            if(isLoginMode) {
                authTitle.innerText = "ƒêƒÉng Nh·∫≠p";
                authActionBtn.innerText = "V√ÄO GAME";
                authToggleText.innerText = "Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω";
            } else {
                authTitle.innerText = "ƒêƒÉng K√Ω";
                authActionBtn.innerText = "ƒêƒÇNG K√ù NGAY";
                authToggleText.innerText = "ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p";
            }
        }

        async function handleAuth() {
            const username = authUser.value.trim();
            const password = authPass.value.trim();
            if(!username || !password) { authMsg.innerText = "Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!"; return; }

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            const url = isLoginMode ? 'login.php' : 'register.php';

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                const data = await response.json();

                if(data.status === 'success') {
                    if(isLoginMode) {
                        currentUser = { id: data.user_id, username: data.username, highscore: data.highscore };
                        userInfoDisplay.innerText = `Xin ch√†o, ${currentUser.username}`;
                        highScoreDisplay.innerText = currentUser.highscore;
                        authScreen.style.display = 'none';
                        startScreen.style.display = 'flex';
                    } else {
                        authMsg.style.color = "#00e676";
                        authMsg.innerText = "ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.";
                        toggleAuthMode();
                    }
                } else {
                    authMsg.style.color = "#ff5252";
                    authMsg.innerText = data.message;
                }
            } catch (error) { console.error(error); authMsg.innerText = "L·ªói k·∫øt n·ªëi server!"; }
        }

        function logout() { currentUser = null; location.reload(); }
        function showStartScreen() { gameOverScreen.style.display = 'none'; startScreen.style.display = 'flex'; highScoreDisplay.innerText = currentUser.highscore; }

        async function saveScoreToDB(newScore) {
            if(!currentUser) return;
            const formData = new FormData();
            formData.append('user_id', currentUser.id);
            formData.append('score', newScore);
            try {
                const response = await fetch('update_score.php', { method: 'POST', body: formData });
                const data = await response.json();
                if(data.new_high) {
                    currentUser.highscore = newScore;
                    newRecordMsg.style.display = 'block';
                } else newRecordMsg.style.display = 'none';
            } catch (e) { console.log(e); }
        }

        // --- H√ÄM B·∫¢NG X·∫æP H·∫†NG M·ªöI ---
        const myRankContainer = document.getElementById('my-rank-container');
        const myRankNum = document.getElementById('my-rank-num');
        const myRankScore = document.getElementById('my-rank-score');

        async function showLeaderboard() {
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            leaderboardScreen.style.display = 'flex';
            leaderboardBody.innerHTML = '<tr><td colspan="3">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            myRankContainer.style.display = 'none'; // ·∫®n t·∫°m th·ªùi

            try {
                // G·ª≠i th√™m user_id l√™n server ƒë·ªÉ t√≠nh h·∫°ng
                let url = 'leaderboard.php';
                if (currentUser) {
                    url += `?user_id=${currentUser.id}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                // 1. Hi·ªÉn th·ªã Top 5
                leaderboardBody.innerHTML = '';
                if (data.top5.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="3">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                } else {
                    data.top5.forEach((user, index) => {
                        let rankClass = '';
                        let icon = '';
                        
                        if (index === 0) { rankClass = 'rank-1'; icon = 'ü•á '; }
                        else if (index === 1) { rankClass = 'rank-2'; icon = 'ü•à '; }
                        else if (index === 2) { rankClass = 'rank-3'; icon = 'ü•â '; }

                        // Highlight d√≤ng c·ªßa m√¨nh n·∫øu m√¨nh n·∫±m trong top 5
                        let isMe = (currentUser && user.username === currentUser.username) ? 'background: rgba(0, 230, 118, 0.2);' : '';

                        const row = `
                            <tr class="${rankClass}" style="${isMe}">
                                <td>${icon}#${index + 1}</td>
                                <td>${user.username}</td>
                                <td>${user.highscore}</td>
                            </tr>
                        `;
                        leaderboardBody.innerHTML += row;
                    });
                }

                // 2. Hi·ªÉn th·ªã H·∫°ng c·ªßa t√¥i (·ªü d∆∞·ªõi c√πng)
                if (data.user_rank) {
                    myRankContainer.style.display = 'block';
                    myRankNum.innerText = data.user_rank.rank;
                    myRankScore.innerText = data.user_rank.highscore;
                }

            } catch (error) {
                console.error(error);
                leaderboardBody.innerHTML = '<tr><td colspan="3" style="color:red">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
            }
        }

        function closeLeaderboard() {
            leaderboardScreen.style.display = 'none';
            // Quay v·ªÅ m√†n h√¨nh Start ho·∫∑c Game Over t√πy tr·∫°ng th√°i
            if (!isPlaying && score === 0) {
                startScreen.style.display = 'flex';
            } else {
                gameOverScreen.style.display = 'flex';
            }
        }

        // --- GAME LOGIC (Gi·ªØ nguy√™n) ---
        function generateQuestion() {
            const type = Math.floor(Math.random() * 4);
            let a, b, operator;
            switch(type) {
                case 0: a = r(99); b = r(99); operator = '+'; correctAnswer = a + b; break;
                case 1: a = r(99); b = r(a); operator = '-'; correctAnswer = a - b; break;
                case 2: a = r2(8)+2; b = r2(8)+2; operator = '√ó'; correctAnswer = a * b; break;
                case 3: b = r2(8)+2; let max = Math.floor(99/b); if(max<2) max=2; let res = r2(max-1)+2; a = b * res; operator = '√∑'; correctAnswer = res; break;
            }
            questionEl.innerText = `${a} ${operator} ${b}`;
        }
        function r(n) { return Math.floor(Math.random() * n) + 1; }
        function r2(n) { return Math.floor(Math.random() * n); }

        function updateLivesDisplay() {
            let heartString = ""; for(let i=0; i<lives; i++) heartString += "‚ù§Ô∏è";
            livesEl.innerText = heartString;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timeLeft = TIME_PER_QUESTION;
            timerBar.style.width = "100%";
            timerBar.style.backgroundColor = "#00e676";
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                let percentage = (timeLeft / TIME_PER_QUESTION) * 100;
                timerBar.style.width = percentage + "%";
                if(percentage < 30) timerBar.style.backgroundColor = "#ff5252";
                if (timeLeft <= 0) handleWrongAnswer();
            }, 100);
        }

        function startGame() {
            score = 0; lives = 3; isPlaying = true; newRecordMsg.style.display = 'none';
            scoreEl.innerText = score; updateLivesDisplay();
            startScreen.style.display = 'none'; gameOverScreen.style.display = 'none';
            inputEl.value = ''; inputEl.focus();
            nextQuestion();
        }

        function nextQuestion() {
            if(!isPlaying) return;
            generateQuestion(); resetTimer(); inputEl.value = '';
        }

        function handleWrongAnswer() {
            lives--; updateLivesDisplay();
            inputEl.classList.add('shake'); setTimeout(() => inputEl.classList.remove('shake'), 400);
            document.body.style.backgroundColor = "#4a2b36"; setTimeout(() => document.body.style.backgroundColor = "", 200);
            if (lives <= 0) endGame(); else nextQuestion();
        }

        function checkAnswer() {
            if (!isPlaying) return;
            const userAns = parseInt(inputEl.value);
            if (userAns === correctAnswer) {
                score++; scoreEl.innerText = score;
                inputEl.classList.add('correct-anim'); setTimeout(() => inputEl.classList.remove('correct-anim'), 200);
                nextQuestion();
            } else handleWrongAnswer();
        }

        function endGame() {
            isPlaying = false; clearInterval(timerInterval);
            finalScoreEl.innerText = score;
            saveScoreToDB(score);
            gameOverScreen.style.display = 'flex';
        }

        inputEl.addEventListener('keydown', function(e) { if (e.key === 'Enter') checkAnswer(); });

    </script>
</body>
</html>